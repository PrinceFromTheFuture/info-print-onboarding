# Stage 1 — Build
FROM node:22.17.0-alpine AS builder

WORKDIR /app

# Copy only package files first for caching
ARG NEXT_PUBLIC_BACKEND_URL
ENV NEXT_PUBLIC_BACKEND_URL=$NEXT_PUBLIC_BACKEND_URL

COPY package*.json ./
RUN npm ci

# Copy the rest of the code and build
COPY . .
RUN npm run build

# Stage 2 — Run
FROM node:22.17.0-alpine AS runner

WORKDIR /app

# Set environment
ENV NODE_ENV=production
ARG NEXT_PUBLIC_BACKEND_URL
ENV NEXT_PUBLIC_BACKEND_URL=$NEXT_PUBLIC_BACKEND_URL

# Install production dependencies

# Copy standalone contents to root (note trailing / on source)
COPY --from=builder --chown=node:node /app/.next/standalone/ ./
# Copy static assets
COPY --from=builder --chown=node:node /app/.next/static ./.next/static
# Copy public assets (if any)
COPY --from=builder --chown=node:node /app/public ./public

# Create non-root user
USER node

EXPOSE 3000
CMD ["node", "server.js"]